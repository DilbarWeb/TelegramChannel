<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfghanPawer - Crypto Investment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #8a2be2;
            --primary-dark: #6a1cb0;
            --secondary: #ff6b6b;
            --accent: #4ecdc4;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --vip1: #ffd700;
            --vip2: #c0c0c0;
            --vip3: #cd7f32;
            --vip4: #e5e4e2;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            color: white;
            position: relative;
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary);
            font-size: 1.5rem;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vip-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--vip1);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .balance-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .balance-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            background: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .action-icon {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .action-label {
            font-weight: 600;
            color: var(--dark);
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        .vip-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .vip-levels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .vip-level {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vip-level.selected {
            border-color: var(--primary);
            background: rgba(138, 43, 226, 0.1);
        }

        .vip-level.vip1 {
            border-color: var(--vip1);
        }

        .vip-level.vip2 {
            border-color: var(--vip2);
        }

        .vip-level.vip3 {
            border-color: var(--vip3);
        }

        .vip-level.vip4 {
            border-color: var(--vip4);
        }

        .vip-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .vip-price {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .vip-profit {
            font-size: 0.8rem;
            color: var(--success);
        }

        .vip-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            width: 100%;
            margin-top: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .vip-btn:hover {
            background: var(--primary-dark);
        }

        .vip-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        .daily-profit-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .profit-timer {
            font-size: 1.2rem;
            margin: 15px 0;
            color: var(--primary);
            font-weight: bold;
        }

        .profit-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .profit-btn:hover {
            background: #218838;
        }

        .profit-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        .referral-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .referral-code {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
            font-family: monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
            border: 1px dashed var(--primary);
        }

        .referral-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .ref-action-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .ref-action-btn:hover {
            background: var(--primary-dark);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .recharge-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .recharge-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .recharge-option {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            border: 2px solid transparent;
        }

        .recharge-option:hover {
            background: #e9ecef;
        }

        .recharge-option.selected {
            border-color: var(--primary);
            background: rgba(138, 43, 226, 0.1);
        }

        .recharge-amount {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .recharge-bonus {
            font-size: 0.8rem;
            color: var(--success);
        }

        .recharge-address {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            border: 1px dashed var(--primary);
            text-align: center;
        }

        .recharge-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .recharge-btn:hover {
            background: var(--primary-dark);
        }

        .history-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .history-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .history-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .history-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-type {
            font-weight: bold;
        }

        .history-amount.positive {
            color: var(--success);
        }

        .history-amount.negative {
            color: var(--danger);
        }

        .history-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.8rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .actions {
                grid-template-columns: 1fr;
            }
            
            .vip-levels {
                grid-template-columns: 1fr;
            }
            
            .referral-stats {
                grid-template-columns: 1fr;
            }
            
            .recharge-options {
                grid-template-columns: 1fr;
            }
            
            .referral-actions {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-paw"></i>
            </div>
            <h1>AfghanPawer</h1>
            <p>Crypto Investment & Rewards</p>
            
            <div class="user-info">
                <div class="avatar" id="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="username" id="username">Loading...</div>
                    <div class="user-id" id="user-id">ID: Loading...</div>
                </div>
            </div>
            <div class="vip-badge" id="vip-badge">No VIP</div>
        </header>

        <div class="balance-card">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount">$<span id="balance">0.00</span></div>
            <div class="balance-label">Available for withdrawal</div>
        </div>

        <div class="actions">
            <div class="action-btn" id="recharge-btn">
                <div class="action-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="action-label">Recharge</div>
            </div>
            <div class="action-btn" id="withdraw-btn">
                <div class="action-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="action-label">Withdraw</div>
            </div>
        </div>

        <div class="vip-section">
            <div class="section-title">
                <i class="fas fa-crown"></i>
                <span>VIP Levels</span>
            </div>
            
            <div class="vip-levels">
                <div class="vip-level vip1" data-level="1" data-price="8" data-profit="3">
                    <div class="vip-name">VIP 1</div>
                    <div class="vip-price">$8</div>
                    <div class="vip-profit">3% Daily Profit</div>
                </div>
                <div class="vip-level vip2" data-level="2" data-price="14" data-profit="3.2">
                    <div class="vip-name">VIP 2</div>
                    <div class="vip-price">$14</div>
                    <div class="vip-profit">3.2% Daily Profit</div>
                </div>
                <div class="vip-level vip3" data-level="3" data-price="18" data-profit="3.5">
                    <div class="vip-name">VIP 3</div>
                    <div class="vip-price">$18</div>
                    <div class="vip-profit">3.5% Daily Profit</div>
                </div>
                <div class="vip-level vip4" data-level="4" data-price="30" data-profit="4">
                    <div class="vip-name">VIP 4</div>
                    <div class="vip-price">$30</div>
                    <div class="vip-profit">4% Daily Profit</div>
                </div>
            </div>
            
            <button class="vip-btn" id="buy-vip-btn" disabled>Buy VIP</button>
        </div>

        <div class="daily-profit-section">
            <div class="section-title">
                <i class="fas fa-coins"></i>
                <span>Daily Profit</span>
            </div>
            
            <div class="profit-timer" id="profit-timer">Next profit available in: 24:00:00</div>
            
            <button class="profit-btn" id="profit-btn" disabled>Claim Daily Profit</button>
        </div>

        <div class="referral-section">
            <div class="section-title">
                <i class="fas fa-user-friends"></i>
                <span>Referral System</span>
            </div>
            
            <p>Invite friends and earn 10% of their investments!</p>
            
            <div class="referral-code" id="referral-code">Loading...</div>
            
            <div class="referral-actions">
                <button class="ref-action-btn" id="copy-ref-btn">Copy Link</button>
                <button class="ref-action-btn" id="share-ref-btn">Share on Telegram</button>
            </div>
            
            <div class="referral-stats">
                <div class="stat-card">
                    <div class="stat-value" id="referrals-count">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$<span id="referral-earnings">0.00</span></div>
                    <div class="stat-label">Referral Earnings</div>
                </div>
            </div>
        </div>

        <div class="history-section">
            <div class="section-title">
                <i class="fas fa-history"></i>
                <span>Transaction History</span>
            </div>
            
            <div class="history-tabs">
                <div class="history-tab active" data-tab="all">All</div>
                <div class="history-tab" data-tab="recharge">Recharge</div>
                <div class="history-tab" data-tab="withdraw">Withdraw</div>
                <div class="history-tab" data-tab="profit">Profit</div>
            </div>
            
            <div class="history-list" id="history-list">
                <div class="loading">Loading transactions...</div>
            </div>
        </div>

        <footer>
            <p>AfghanPawer &copy; 2023 - All rights reserved</p>
        </footer>
    </div>

    <!-- Recharge Modal -->
    <div class="modal" id="recharge-modal">
        <div class="modal-content fade-in">
            <div class="modal-header">
                <div class="modal-title">Recharge Account</div>
                <button class="close-modal">&times;</button>
            </div>
            <p>Minimum recharge amount: $8.00 (USDT BEP20 only)</p>
            
            <div class="recharge-options">
                <div class="recharge-option" data-amount="8">
                    <div class="recharge-amount">$8</div>
                </div>
                <div class="recharge-option selected" data-amount="20">
                    <div class="recharge-amount">$20</div>
                </div>
                <div class="recharge-option" data-amount="50">
                    <div class="recharge-amount">$50</div>
                </div>
                <div class="recharge-option" data-amount="100">
                    <div class="recharge-amount">$100</div>
                </div>
            </div>
            
            <div style="margin: 15px 0;">
                <label for="custom-amount">Or enter custom amount:</label>
                <input type="number" id="custom-amount" min="8" step="0.01" value="20" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="recharge-address" id="recharge-address">
                0x5Dff7E7F810AF7C0f45EF9902c3ba0E8ED3Aa497
            </div>
            
            <p style="font-size: 0.9rem; color: var(--gray); text-align: center;">
                Send USDT (BEP20) to this address. After 3 network confirmations, your balance will be updated automatically.
            </p>
            
            <button class="recharge-btn" id="confirm-recharge">I've Sent the Payment</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal" id="withdraw-modal">
        <div class="modal-content fade-in">
            <div class="modal-header">
                <div class="modal-title">Withdraw Funds</div>
                <button class="close-modal">&times;</button>
            </div>
            <p>Minimum withdrawal amount: $5.00</p>
            
            <div style="margin: 15px 0;">
                <label for="withdraw-amount">Amount:</label>
                <input type="number" id="withdraw-amount" min="5" step="0.01" value="5" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="margin: 15px 0;">
                <label for="withdraw-address">Your USDT BEP20 Address:</label>
                <input type="text" id="withdraw-address" placeholder="Enter your USDT BEP20 address" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <button class="recharge-btn" id="confirm-withdraw">Request Withdrawal</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD4UbW_Iy4kUWH3V70Q1mWCI4-_KFk6ku4",
            authDomain: "onlinewark-a0147.firebaseapp.com",
            databaseURL: "https://onlinewark-a0147-default-rtdb.firebaseio.com",
            projectId: "onlinewark-a0147",
            storageBucket: "onlinewark-a0147.appspot.com",
            messagingSenderId: "92155538620",
            appId: "1:92155538620:android:5e198a8eea6bf17f61f4b9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Initialize Telegram Web App
        let tg = window.Telegram.WebApp;
        
        // Expand the app to full height
        tg.expand();
        
        // Get user data from Telegram
        const user = tg.initDataUnsafe.user;
        let userId = user ? user.id.toString() : null;
        
        if (!userId) {
            // If no user ID from Telegram, show error
            document.body.innerHTML = `
                <div class="container">
                    <div style="text-align: center; padding: 50px 20px;">
                        <h1 style="color: var(--danger);">Error</h1>
                        <p>This app must be opened from Telegram. Please open it via @AfghanPawer_Bot</p>
                    </div>
                </div>
            `;
            throw new Error("User not authenticated via Telegram");
        }
        
        // VIP levels configuration
        const vipLevels = {
            1: { price: 8, profit: 3 },
            2: { price: 14, profit: 3.2 },
            3: { price: 18, profit: 3.5 },
            4: { price: 30, profit: 4 }
        };
        
        // USDT BEP20 address for recharges
        const usdtBep20Address = "0x5Dff7E7F810AF7C0f45EF9902c3ba0E8ED3Aa497";
        
        // Set user information from Telegram
        document.getElementById('username').textContent = user.first_name || 'User';
        document.getElementById('user-id').textContent = `ID: ${user.id}`;
        
        // Set user avatar if available
        if (user.photo_url) {
            document.getElementById('user-avatar').innerHTML = `<img src="${user.photo_url}" alt="User Avatar">`;
        }
        
        // Generate referral code
        const referralCode = `AFG${user.id}`;
        document.getElementById('referral-code').textContent = referralCode;
        
        // User data object
        let userData = {
            balance: 0,
            vipLevel: 0,
            lastProfitClaim: 0,
            referrals: 0,
            referralEarnings: 0,
            rechargeTotal: 0,
            withdrawTotal: 0,
            profitTotal: 0,
            transactions: []
        };
        
        // Load user data from Firebase
        function loadUserData() {
            const userRef = database.ref('users/' + userId);
            
            userRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    
                    // Ensure all required fields exist
                    if (!userData.transactions) userData.transactions = [];
                    if (!userData.referrals) userData.referrals = 0;
                    if (!userData.referralEarnings) userData.referralEarnings = 0;
                    if (!userData.rechargeTotal) userData.rechargeTotal = 0;
                    if (!userData.withdrawTotal) userData.withdrawTotal = 0;
                    if (!userData.profitTotal) userData.profitTotal = 0;
                    
                    updateUI();
                } else {
                    // Create new user with initial data
                    userData = {
                        balance: 0,
                        vipLevel: 0,
                        lastProfitClaim: 0,
                        referrals: 0,
                        referralEarnings: 0,
                        rechargeTotal: 0,
                        withdrawTotal: 0,
                        profitTotal: 0,
                        transactions: [],
                        telegramData: {
                            id: user.id,
                            first_name: user.first_name,
                            username: user.username,
                            photo_url: user.photo_url
                        },
                        joinedDate: new Date().toISOString()
                    };
                    
                    userRef.set(userData);
                    updateUI();
                }
            }, (error) => {
                console.error('Error loading user data:', error);
                tg.showPopup({
                    title: 'Connection Error',
                    message: 'Could not load your data. Please check your connection.',
                    buttons: [{type: 'ok'}]
                });
            });
        }
        
        // Update UI with user data
        function updateUI() {
            document.getElementById('balance').textContent = userData.balance.toFixed(2);
            document.getElementById('referrals-count').textContent = userData.referrals;
            document.getElementById('referral-earnings').textContent = userData.referralEarnings.toFixed(2);
            
            // Update VIP badge
            const vipBadge = document.getElementById('vip-badge');
            if (userData.vipLevel > 0) {
                vipBadge.textContent = `VIP ${userData.vipLevel}`;
                vipBadge.style.background = getVipColor(userData.vipLevel);
            } else {
                vipBadge.textContent = 'No VIP';
                vipBadge.style.background = '#6c757d';
            }
            
            // Update VIP purchase button
            const buyVipBtn = document.getElementById('buy-vip-btn');
            const selectedVip = document.querySelector('.vip-level.selected');
            if (selectedVip) {
                const vipLevel = parseInt(selectedVip.getAttribute('data-level'));
                const vipPrice = parseFloat(selectedVip.getAttribute('data-price'));
                
                if (userData.balance >= vipPrice && userData.vipLevel < vipLevel) {
                    buyVipBtn.disabled = false;
                    buyVipBtn.textContent = `Buy VIP ${vipLevel} - $${vipPrice}`;
                } else {
                    buyVipBtn.disabled = true;
                    if (userData.vipLevel >= vipLevel) {
                        buyVipBtn.textContent = 'Already Purchased';
                    } else {
                        buyVipBtn.textContent = 'Insufficient Balance';
                    }
                }
            }
            
            // Update profit claim button
            const profitBtn = document.getElementById('profit-btn');
            const profitTimer = document.getElementById('profit-timer');
            
            if (userData.vipLevel > 0) {
                const now = new Date().getTime();
                const lastClaim = userData.lastProfitClaim || 0;
                const nextClaimTime = lastClaim + (24 * 60 * 60 * 1000); // 24 hours
                
                if (now >= nextClaimTime) {
                    profitBtn.disabled = false;
                    profitBtn.textContent = `Claim Daily Profit (${vipLevels[userData.vipLevel].profit}%)`;
                    profitTimer.textContent = 'Profit available now!';
                } else {
                    profitBtn.disabled = true;
                    const timeLeft = nextClaimTime - now;
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    profitTimer.textContent = `Next profit available in: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    profitBtn.textContent = 'Profit Claimed Today';
                }
            } else {
                profitBtn.disabled = true;
                profitBtn.textContent = 'VIP Required';
                profitTimer.textContent = 'Purchase VIP to earn daily profits';
            }
            
            // Update transaction history
            updateHistory();
        }
        
        // Get VIP color based on level
        function getVipColor(level) {
            switch(level) {
                case 1: return '#ffd700';
                case 2: return '#c0c0c0';
                case 3: return '#cd7f32';
                case 4: return '#e5e4e2';
                default: return '#6c757d';
            }
        }
        
        // Update transaction history
        function updateHistory() {
            const historyList = document.getElementById('history-list');
            
            if (!userData.transactions || userData.transactions.length === 0) {
                historyList.innerHTML = '<div class="history-item">No transactions yet</div>';
                return;
            }
            
            // Get active tab
            const activeTab = document.querySelector('.history-tab.active').getAttribute('data-tab');
            
            // Filter transactions based on active tab
            const filteredTransactions = userData.transactions.filter(transaction => {
                if (activeTab === 'all') return true;
                return transaction.type === activeTab;
            });
            
            // Sort transactions by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Clear and display transactions
            historyList.innerHTML = '';
            
            filteredTransactions.forEach(transaction => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const amountClass = transaction.amount >= 0 ? 'positive' : 'negative';
                const amountSign = transaction.amount >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div class="history-type">${transaction.description}</div>
                        <div class="history-date">${formatDate(transaction.date)}</div>
                    </div>
                    <div class="history-amount ${amountClass}">${amountSign}$${Math.abs(transaction.amount).toFixed(2)}</div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString();
        }
        
        // Save user data to Firebase
        function saveUserData() {
            const userRef = database.ref('users/' + userId);
            userRef.set(userData).catch((error) => {
                console.error('Error saving user data:', error);
                tg.showPopup({
                    title: 'Error',
                    message: 'Failed to save data. Please check your connection.',
                    buttons: [{type: 'ok'}]
                });
            });
        }
        
        // Add transaction to history
        function addTransaction(type, amount, description) {
            if (!userData.transactions) {
                userData.transactions = [];
            }
            
            userData.transactions.push({
                type: type,
                amount: amount,
                date: new Date().toISOString(),
                description: description
            });
            
            // Keep only last 50 transactions
            if (userData.transactions.length > 50) {
                userData.transactions = userData.transactions.slice(-50);
            }
        }
        
        // Modal functionality
        const rechargeBtn = document.getElementById('recharge-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const rechargeModal = document.getElementById('recharge-modal');
        const withdrawModal = document.getElementById('withdraw-modal');
        const closeButtons = document.querySelectorAll('.close-modal');
        
        rechargeBtn.addEventListener('click', () => {
            rechargeModal.style.display = 'flex';
        });
        
        withdrawBtn.addEventListener('click', () => {
            if (userData.balance < 5) {
                tg.showPopup({
                    title: 'Insufficient Balance',
                    message: 'Minimum withdrawal amount is $5.00',
                    buttons: [{type: 'ok'}]
                });
                return;
            }
            withdrawModal.style.display = 'flex';
        });
        
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                rechargeModal.style.display = 'none';
                withdrawModal.style.display = 'none';
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === rechargeModal) {
                rechargeModal.style.display = 'none';
            }
            if (event.target === withdrawModal) {
                withdrawModal.style.display = 'none';
            }
        });
        
        // Recharge option selection
        const rechargeOptions = document.querySelectorAll('.recharge-option');
        const customAmountInput = document.getElementById('custom-amount');
        
        rechargeOptions.forEach(option => {
            option.addEventListener('click', () => {
                rechargeOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                customAmountInput.value = option.getAttribute('data-amount');
            });
        });
        
        customAmountInput.addEventListener('input', () => {
            rechargeOptions.forEach(opt => opt.classList.remove('selected'));
        });
        
        // Confirm recharge
        document.getElementById('confirm-recharge').addEventListener('click', () => {
            const amount = parseFloat(customAmountInput.value);
            
            if (amount < 8) {
                tg.showPopup({
                    title: 'Error',
                    message: 'Minimum recharge amount is $8.00',
                    buttons: [{type: 'ok'}]
                });
                return;
            }
            
            rechargeModal.style.display = 'none';
            
            tg.showPopup({
                title: 'Recharge Instructions',
                message: `Send $${amount} USDT (BEP20) to the address shown. Your balance will update after 3 network confirmations.`,
                buttons: [{type: 'ok'}]
            });
            
            // In a real app, you would wait for blockchain confirmation
            // For demo purposes, we'll add a pending transaction
            addTransaction('pending_recharge', amount, `Pending Recharge - $${amount}`);
            updateUI();
        });
        
        // Confirm withdrawal
        document.getElementById('confirm-withdraw').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const address = document.getElementById('withdraw-address').value;
            
            if (amount < 5) {
                tg.showPopup({
                    title: 'Error',
                    message: 'Minimum withdrawal amount is $5.00',
                    buttons: [{type: 'ok'}]
                });
                return;
            }
            
            if (amount > userData.balance) {
                tg.showPopup({
                    title: 'Error',
                    message: 'Insufficient balance',
                    buttons: [{type: 'ok'}]
                });
                return;
            }
            
            if (!address || address.length < 10) {
                tg.showPopup({
                    title: 'Error',
                    message: 'Please enter a valid USDT BEP20 address',
                    buttons: [{type: 'ok'}]
                });
                return;
            }
            
            withdrawModal.style.display = 'none';
            
            // Process withdrawal
            userData.balance -= amount;
            userData.withdrawTotal += amount;
            addTransaction('withdraw', -amount, `Withdrawal to ${address.substring(0, 10)}...`);
            updateUI();
            saveUserData();
            
            tg.showPopup({
                title: 'Withdrawal Requested',
                message: `Your withdrawal of $${amount.toFixed(2)} has been submitted. It will be processed within 24 hours.`,
                buttons: [{type: 'ok'}]
            });
            
            // Clear the form
            document.getElementById('withdraw-amount').value = '5';
            document.getElementById('withdraw-address').value = '';
        });
        
        // VIP level selection
        const vipLevelElements = document.querySelectorAll('.vip-level');
        vipLevelElements.forEach(level => {
            level.addEventListener('click', () => {
                vipLevelElements.forEach(l => l.classList.remove('selected'));
                level.classList.add('selected');
                updateUI();
            });
        });
        
        // Auto-select first VIP level
        if (vipLevelElements.length > 0) {
            vipLevelElements[0].classList.add('selected');
        }
        
        // Buy VIP
        document.getElementById('buy-vip-btn').addEventListener('click', () => {
            const selectedVip = document.querySelector('.vip-level.selected');
            const vipLevel = parseInt(selectedVip.getAttribute('data-level'));
            const vipPrice = parseFloat(selectedVip.getAttribute('data-price'));
            
            if (userData.balance >= vipPrice && userData.vipLevel < vipLevel) {
                tg.showPopup({
                    title: 'Confirm VIP Purchase',
                    message: `Are you sure you want to purchase VIP ${vipLevel} for $${vipPrice}?`,
                    buttons: [
                        {type: 'cancel'},
                        {type: 'ok', text: 'Confirm'}
                    ]
                }, (buttonId) => {
                    if (buttonId === 'ok') {
                        // Process VIP purchase
                        userData.balance -= vipPrice;
                        userData.vipLevel = vipLevel;
                        addTransaction('vip', -vipPrice, `VIP ${vipLevel} Purchase`);
                        
                        // In a real app, you would send the payment to the blockchain address
                        // For demo, we'll simulate it with a 10-second delay
                        tg.showPopup({
                            title: 'Processing',
                            message: 'Your VIP purchase is being processed...',
                            buttons: []
                        });
                        
                        setTimeout(() => {
                            updateUI();
                            saveUserData();
                            
                            tg.showPopup({
                                title: 'VIP Activated',
                                message: `Congratulations! You are now VIP ${vipLevel}. You can now claim daily profits.`,
                                buttons: [{type: 'ok'}]
                            });
                        }, 10000); // 10 seconds delay to simulate blockchain processing
                    }
                });
            }
        });
        
        // Claim daily profit
        document.getElementById('profit-btn').addEventListener('click', () => {
            if (userData.vipLevel > 0) {
                const now = new Date().getTime();
                const lastClaim = userData.lastProfitClaim || 0;
                const nextClaimTime = lastClaim + (24 * 60 * 60 * 1000);
                
                if (now >= nextClaimTime) {
                    const profitPercentage = vipLevels[userData.vipLevel].profit;
                    const profitAmount = (userData.rechargeTotal * profitPercentage) / 100;
                    
                    userData.balance += profitAmount;
                    userData.lastProfitClaim = now;
                    userData.profitTotal += profitAmount;
                    addTransaction('profit', profitAmount, `Daily Profit (VIP ${userData.vipLevel})`);
                    
                    updateUI();
                    saveUserData();
                    
                    tg.showPopup({
                        title: 'Profit Claimed',
                        message: `You've received $${profitAmount.toFixed(2)} daily profit!`,
                        buttons: [{type: 'ok'}]
                    });
                }
            }
        });
        
        // Copy referral link
        document.getElementById('copy-ref-btn').addEventListener('click', () => {
            const referralLink = `https://t.me/AfghanPawer_Bot?start=${userId}`;
            navigator.clipboard.writeText(referralLink).then(() => {
                tg.showPopup({
                    title: 'Copied!',
                    message: 'Referral link copied to clipboard',
                    buttons: [{type: 'ok'}]
                });
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = referralLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                tg.showPopup({
                    title: 'Copied!',
                    message: 'Referral link copied to clipboard',
                    buttons: [{type: 'ok'}]
                });
            });
        });
        
        // Share referral link on Telegram
        document.getElementById('share-ref-btn').addEventListener('click', () => {
            const referralLink = `https://t.me/AfghanPawer_Bot?start=${userId}`;
            const message = `Join AfghanPawer and earn daily profits! Use my referral link: ${referralLink}`;
            
            if (tg.isVersionAtLeast('6.0')) {
                tg.shareUrl(message, referralLink);
            } else {
                // Fallback for older versions
                navigator.clipboard.writeText(message).then(() => {
                    tg.showPopup({
                        title: 'Copied!',
                        message: 'Referral message copied to clipboard. You can now share it on Telegram.',
                        buttons: [{type: 'ok'}]
                    });
                });
            }
        });
        
        // History tab switching
        const historyTabs = document.querySelectorAll('.history-tab');
        historyTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                historyTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                updateHistory();
            });
        });
        
        // Set recharge address
        document.getElementById('recharge-address').textContent = usdtBep20Address;
        
        // Initialize the app
        loadUserData();
        
        // Update profit timer every second
        setInterval(updateUI, 1000);
    </script>
</body>
</html> 
